# –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞ MAX Diagnostic Bot

## üéØ –û –ø—Ä–æ–µ–∫—Ç–µ

Telegram-–±–æ—Ç –¥–ª—è AI-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤ –∏ –ø—Ä–æ–¥–∞–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.

**–°—Ç–µ–∫:**
- Python 3.11+
- aiogram 3.x (async Telegram Bot API)
- SQLAlchemy 2.0 (async ORM)
- PostgreSQL (Supabase)
- RouterAI (Claude/GPT API)

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
src/
‚îú‚îÄ‚îÄ ai/           # AI-–∫–ª–∏–µ–Ω—Ç –∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã
‚îú‚îÄ‚îÄ analytics/    # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, PDP, –¥–∏–Ω–∞–º–∏–∫–∞
‚îú‚îÄ‚îÄ bot/          # Telegram –±–æ—Ç
‚îÇ   ‚îú‚îÄ‚îÄ handlers/ # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/# Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ middlewares/
‚îú‚îÄ‚îÄ core/         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –ø—Ä–æ–º–ø—Ç—ã
‚îú‚îÄ‚îÄ db/           # ORM –º–æ–¥–µ–ª–∏ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
‚îú‚îÄ‚îÄ payments/     # Telegram Payments API
‚îî‚îÄ‚îÄ utils/        # PDF, —Å–ø–ª–∏—Ç—Ç–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
```

---

## üîß –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –û–±—â–∏–µ

1. **–Ø–∑—ã–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:** —Ä—É—Å—Å–∫–∏–π
2. **–ö–æ–¥:** –∞–Ω–≥–ª–∏–π—Å–∫–∏–π (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Ñ—É–Ω–∫—Ü–∏–∏)
3. **–¢–∏–ø-—Ö–∏–Ω—Ç—ã:** –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –≤–µ–∑–¥–µ
4. **Async:** –≤–µ—Å—å –∫–æ–¥ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π

### –°—Ç–∏–ª—å

```python
# ‚úÖ –•–æ—Ä–æ—à–æ
async def get_user_balance(session: AsyncSession, user_id: int) -> UserBalance:
    """–ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    ...

# ‚ùå –ü–ª–æ—Ö–æ
def getBalance(s, uid):
    ...
```

### –ò–º–ø–æ—Ä—Ç—ã

```python
# –ü–æ—Ä—è–¥–æ–∫:
# 1. stdlib
# 2. third-party
# 3. local (src.*)

import logging
from datetime import datetime

from aiogram import Router, F
from sqlalchemy.ext.asyncio import AsyncSession

from src.db import get_session
from src.db.repositories import balance_repo
```

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (handlers)

```python
@router.callback_query(F.data == "action_name", SomeState.state_name)
async def handle_action(callback: CallbackQuery, state: FSMContext):
    """–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —á—Ç–æ –¥–µ–ª–∞–µ—Ç."""
    user_id = callback.from_user.id
    
    # –õ–æ–≥–∏–∫–∞
    async with get_session() as db:
        ...
    
    await callback.answer()
```

### –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

- –ò—Å–ø–æ–ª—å–∑—É–π `async with get_session() as db:` –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –≤ `src/db/repositories/`
- –ú–æ–¥–µ–ª–∏ –≤ `src/db/models.py`

### Telegram Messages

- –õ–∏–º–∏—Ç: 4096 —Å–∏–º–≤–æ–ª–æ–≤
- –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: `send_long_message()` –∏–∑ `utils/message_splitter.py`
- HTML parse_mode (–Ω–µ Markdown)

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

### –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ PostgreSQL

–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –∏–º–µ–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫:
- `mode`, `user`, `table`, `order`, `group`, `limit`

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `diagnostic_mode` –≤–º–µ—Å—Ç–æ `mode`.

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `src/core/config.py` —á–µ—Ä–µ–∑ Pydantic Settings.
–ù–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏!

### –î–µ–ø–ª–æ–π

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /root/bot
git pull
docker compose down
docker compose up -d --build
docker logs diagnostic-bot --tail 30
```

### üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ó–∞—â–∏—Ç–∞ –ö–æ–Ω—Ç–µ–Ω—Ç–∞

- **Paywall Check:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–ª–∞—Ç–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É (–∏—Å—Ç–æ—Ä–∏—è, PDF, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã).
- **No Free Rides:** –î–µ–º–æ-—Ä–µ–∂–∏–º –Ω–µ –¥–æ–ª–∂–µ–Ω –¥–∞–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ª–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —á–µ—Ä–µ–∑ –ª–∞–∑–µ–π–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏—Å—Ç–æ—Ä–∏—è).
- **Validation:** –í–∞–ª–∏–¥–∏—Ä—É–π –≤—Å–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- **Content Integrity:** –¢–µ–∫—Å—Ç—ã –∏ –ø—Ä–æ–º–ø—Ç—ã –Ω–µ –¥–æ–ª–∂–Ω—ã —É—Ç–µ–∫–∞—Ç—å –∏–ª–∏ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –ø—Ä–∞–≤.

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

- [ ] üõ° **–ü–†–û–í–ï–†–ï–ù–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –î–û–°–¢–£–ü –ö –ö–û–ù–¢–ï–ù–¢–£**
- [ ] –ù–µ—Ç —Ö–∞—Ä–¥–∫–æ–¥–∞ —Ç–æ–∫–µ–Ω–æ–≤/–∫–ª—é—á–µ–π
- [ ] –¢–∏–ø-—Ö–∏–Ω—Ç—ã –≤–µ–∑–¥–µ
- [ ] Docstrings –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (try/except)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
