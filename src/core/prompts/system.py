"""
Системные промпты для AI диагностики.
"""

# Базовый системный промпт для генерации вопросов
QUESTION_GENERATOR_SYSTEM = """Ты — эксперт-диагност с 20-летним опытом найма и оценки специалистов в IT.
Твоя задача — задавать глубокие, проницательные вопросы, чтобы максимально точно оценить уровень кандидата.

ПРАВИЛА ГЕНЕРАЦИИ ВОПРОСОВ:
1. Каждый вопрос должен быть УНИКАЛЬНЫМ и основан на ВСЕХ предыдущих ответах
2. Ищи противоречия, пробелы, интересные паттерны в ответах
3. Не задавай вопросы "в лоб" — используй косвенные техники
4. Чередуй типы вопросов:
   - Ситуационные: "Расскажи про случай, когда..."
   - Гипотетические: "Что бы ты сделал, если..."
   - Рефлексивные: "Почему ты принял такое решение?"
   - Провокационные: "А если бы [противоположный сценарий]?"
   - Метакогнитивные: "Как ты понимаешь, что делаешь это хорошо?"
5. Избегай социально желательных вопросов (на которые легко дать "правильный" ответ)
6. Создавай контролируемый дискомфорт для проверки реакции
7. Углубляйся в выявленные слабые места

ФОРМАТ ОТВЕТА:
Верни ТОЛЬКО текст вопроса. Без пояснений, без нумерации, без кавычек."""


# Промпт для анализа ответа
ANSWER_ANALYZER_SYSTEM = """Ты — эксперт по оценке специалистов. Анализируй ответ кандидата максимально глубоко.

ОЦЕНИ ПО КРИТЕРИЯМ (0-10 каждый):

1. **depth** — Глубина ответа
   - 0-3: Поверхностный, общие слова, клише
   - 4-6: Есть конкретика, но без деталей
   - 7-10: Глубокий, с примерами, деталями, рефлексией

2. **self_awareness** — Самоосознание
   - 0-3: Не видит своих ограничений, завышенная самооценка
   - 4-6: Частично осознает сильные/слабые стороны
   - 7-10: Честная рефлексия, понимает зоны роста

3. **structure** — Структурность мышления
   - 0-3: Хаотично, перескакивает, нет логики
   - 4-6: Есть структура, но неполная
   - 7-10: Чёткая логика, системный подход

4. **honesty** — Честность/аутентичность
   - 0-3: Явно "продаёт себя", социально желательные ответы
   - 4-6: Смесь честности и самопрезентации
   - 7-10: Искренний, говорит в том числе о неудачах

5. **expertise** — Профессионализм
   - 0-3: Поверхностное понимание темы
   - 4-6: Средний уровень владения
   - 7-10: Глубокая экспертиза, знает нюансы

ТАКЖЕ ВЫЯВИ:
- key_insights: 2-3 ключевых наблюдения об ответе
- gaps: Пробелы или противоречия для дальнейшего исследования
- hypothesis: Гипотеза о личности/уровне кандидата

ФОРМАТ ОТВЕТА — строго JSON:
{
  "scores": {
    "depth": X,
    "self_awareness": X,
    "structure": X,
    "honesty": X,
    "expertise": X
  },
  "key_insights": ["...", "..."],
  "gaps": ["...", "..."],
  "hypothesis": "..."
}"""


def get_question_prompt(
    role: str,
    role_name: str,
    experience: str,
    question_number: int,
    conversation_history: list[dict],
    analysis_history: list[dict],
) -> list[dict]:
    """
    Сформировать промпт для генерации следующего вопроса.
    
    Args:
        role: Роль (designer/product)
        role_name: Название роли
        experience: Уровень опыта
        question_number: Номер вопроса (1-10)
        conversation_history: История вопросов и ответов
        analysis_history: История анализов ответов
    
    Returns:
        Список сообщений для AI
    """
    # Формируем контекст из истории
    history_text = ""
    for i, item in enumerate(conversation_history, 1):
        history_text += f"\n\nВОПРОС {i}: {item['question']}\nОТВЕТ: {item['answer']}"
        
        if i <= len(analysis_history):
            analysis = analysis_history[i-1]
            history_text += f"\nАНАЛИЗ: {analysis.get('hypothesis', 'Нет данных')}"
            if analysis.get('gaps'):
                history_text += f"\nПРОБЕЛЫ: {', '.join(analysis['gaps'])}"
    
    # Определяем фокус вопроса в зависимости от номера
    focus_map = {
        1: "Широкий скрининг — выяви сильные и слабые зоны",
        2: "Углубление в выявленную сильную/слабую сторону",
        3: "Проверка Hard Skills — технические компетенции",
        4: "Проверка Hard Skills — методологии и процессы",
        5: "Проверка Soft Skills — коммуникация",
        6: "Проверка Soft Skills — конфликты и сложные ситуации",
        7: "Проверка Thinking — системное мышление",
        8: "Проверка Thinking — принятие решений",
        9: "Проверка Mindset — ценности и мотивация",
        10: "Финальное давление — глубинная рефлексия",
    }
    
    focus = focus_map.get(question_number, "Общая оценка")
    
    user_prompt = f"""КОНТЕКСТ ДИАГНОСТИКИ:
- Роль: {role_name}
- Опыт: {experience}
- Номер вопроса: {question_number}/10
- Фокус этого вопроса: {focus}

ИСТОРИЯ ДИАЛОГА:{history_text if history_text else " Это первый вопрос."}

Сгенерируй следующий вопрос для кандидата. Помни:
- Вопрос должен быть на русском языке
- Учитывай ВСЮ историю ответов
- Копай в выявленные пробелы
- Фокус: {focus}"""

    return [
        {"role": "system", "content": QUESTION_GENERATOR_SYSTEM},
        {"role": "user", "content": user_prompt},
    ]


def get_analysis_prompt(question: str, answer: str, role: str) -> list[dict]:
    """
    Сформировать промпт для анализа ответа.
    
    Args:
        question: Заданный вопрос
        answer: Ответ кандидата
        role: Роль (designer/product)
        
    Returns:
        Список сообщений для AI
    """
    role_context = {
        "designer": "UI/UX дизайнера",
        "product": "продакт-менеджера",
    }
    
    user_prompt = f"""Проанализируй ответ кандидата на позицию {role_context.get(role, 'специалиста')}.

ВОПРОС: {question}

ОТВЕТ КАНДИДАТА:
{answer}

Дай оценку по всем критериям и выяви ключевые инсайты."""

    return [
        {"role": "system", "content": ANSWER_ANALYZER_SYSTEM},
        {"role": "user", "content": user_prompt},
    ]

