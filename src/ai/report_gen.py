"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ AI-–æ—Ç—á—ë—Ç–∞.
"""
import logging
from src.ai.client import chat_completion
from src.ai.answer_analyzer import calculate_category_scores

logger = logging.getLogger(__name__)


REPORT_SYSTEM_PROMPT = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ—Ü–µ–Ω–∫–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ HR –∏ –Ω–∞–π–º–µ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π, –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ –∫–∞–Ω–¥–∏–¥–∞—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤.

–§–û–†–ú–ê–¢ –û–¢–ß–Å–¢–ê (—Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ):

1. **–û–ë–©–ï–ï –í–ü–ï–ß–ê–¢–õ–ï–ù–ò–ï** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
–ö—Ä–∞—Ç–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∫–∞–∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.

2. **–°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´** (3-5 –ø—É–Ω–∫—Ç–æ–≤)
–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–∏–ª—å–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤.

3. **–ó–û–ù–´ –†–ê–ó–í–ò–¢–ò–Ø** (3-5 –ø—É–Ω–∫—Ç–æ–≤)
–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.

4. **HARD SKILLS** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
–û—Ü–µ–Ω–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π.

5. **SOFT SKILLS** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
–û—Ü–µ–Ω–∫–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ –∏ —Ä–∞–±–æ—Ç—ã —Å –ª—é–¥—å–º–∏.

6. **–ú–´–®–õ–ï–ù–ò–ï** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
–û—Ü–µ–Ω–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ—Å—Ç–∏, –≥–ª—É–±–∏–Ω—ã —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π.

7. **MINDSET** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
–û—Ü–µ–Ω–∫–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π, –º–æ—Ç–∏–≤–∞—Ü–∏–∏, –∑—Ä–µ–ª–æ—Å—Ç–∏.

8. **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –†–ê–ó–í–ò–¢–ò–Æ** (3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞)
–ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–µ–ª–∞—Ç—å –¥–ª—è —Ä–æ—Å—Ç–∞.

9. **–ò–¢–û–ì–û–í–´–ô –í–ï–†–î–ò–ö–¢** (1-2 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
–ö—Ä–∞—Ç–∫–æ: –Ω–∞ –∫–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç –∏ –ø–æ—á–µ–º—É.

–ü–†–ê–í–ò–õ–ê:
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º ‚Äî —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –ò–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ –∏ –≤–æ–¥—ã
- –ë—É–¥—å —á–µ—Å—Ç–Ω—ã–º, –Ω–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–º
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π emoji
- –ò—Å–ø–æ–ª—å–∑—É–π HTML —Ç–µ–≥–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: <b>–∂–∏—Ä–Ω—ã–π</b>, <i>–∫—É—Ä—Å–∏–≤</i>
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown (# ## * –∏ —Ç.–¥.) ‚Äî —Ç–æ–ª—å–∫–æ HTML"""


async def generate_detailed_report(
    role: str,
    role_name: str,
    experience: str,
    conversation_history: list[dict],
    analysis_history: list[dict],
) -> str:
    """
    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π AI-–æ—Ç—á—ë—Ç.
    
    Args:
        role: –†–æ–ª—å (designer/product)
        role_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏
        experience: –£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞
        conversation_history: –ò—Å—Ç–æ—Ä–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
        analysis_history: –ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤
        
    Returns:
        –¢–µ–∫—Å—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞
    """
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–ª–ª—ã
    scores = calculate_category_scores(analysis_history)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
    dialog_text = ""
    for i, item in enumerate(conversation_history, 1):
        dialog_text += f"\n\n–í–û–ü–†–û–° {i}: {item['question']}\n–û–¢–í–ï–¢: {item['answer']}"
    
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–Ω—Å–∞–π—Ç—ã –∏–∑ –∞–Ω–∞–ª–∏–∑–æ–≤
    all_insights = []
    all_gaps = []
    for analysis in analysis_history:
        all_insights.extend(analysis.get("key_insights", []))
        all_gaps.extend(analysis.get("gaps", []))
    
    user_prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏ –Ω–∞–ø–∏—à–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç.

–ü–†–û–§–ò–õ–¨ –ö–ê–ù–î–ò–î–ê–¢–ê:
- –†–æ–ª—å: {role_name}
- –ó–∞—è–≤–ª–µ–Ω–Ω—ã–π –æ–ø—ã—Ç: {experience}

–ë–ê–õ–õ–´ (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤):
- Hard Skills: {scores['hard_skills']}/30
- Soft Skills: {scores['soft_skills']}/25
- Thinking: {scores['thinking']}/25
- Mindset: {scores['mindset']}/20
- –ò–¢–û–ì–û: {scores['total']}/100

–ö–õ–Æ–ß–ï–í–´–ï –ù–ê–ë–õ–Æ–î–ï–ù–ò–Ø –ò–ó –ê–ù–ê–õ–ò–ó–ê:
{chr(10).join('- ' + i for i in all_insights[:10]) if all_insights else '- –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}

–í–´–Ø–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–ï–õ–´:
{chr(10).join('- ' + g for g in all_gaps[:5]) if all_gaps else '- –ù–µ –≤—ã—è–≤–ª–µ–Ω–æ'}

–ü–û–õ–ù–´–ô –î–ò–ê–õ–û–ì:
{dialog_text}

–ù–∞–ø–∏—à–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å–æ–≥–ª–∞—Å–Ω–æ —Ñ–æ—Ä–º–∞—Ç—É."""

    try:
        report = await chat_completion(
            messages=[
                {"role": "system", "content": REPORT_SYSTEM_PROMPT},
                {"role": "user", "content": user_prompt},
            ],
            temperature=0.4,  # –ë–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –≤—ã–≤–æ–¥
            max_tokens=4000,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç—á—ë—Ç –Ω–µ –æ–±—Ä–µ–∑–∞–Ω (–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ—á–∫–æ–π –∏–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º —Ç–µ–≥–æ–º)
        report = report.strip()
        if report and not report.endswith(('.', '!', '?', '>', '¬ª')):
            # –î–æ–±–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ –µ—Å–ª–∏ –æ–±—Ä–µ–∑–∞–Ω–æ
            report += "..."
            logger.warning("Report appears to be truncated, added ellipsis")
        
        return report
        
    except Exception as e:
        logger.error(f"Failed to generate report: {e}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—ã–π –æ—Ç—á—ë—Ç
        return generate_fallback_report(role_name, experience, scores, all_insights, all_gaps)


def generate_fallback_report(
    role_name: str,
    experience: str,
    scores: dict,
    insights: list[str],
    gaps: list[str],
) -> str:
    """Fallback –æ—Ç—á—ë—Ç –µ—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."""
    
    total = scores["total"]
    if total >= 80:
        level = "Senior / Lead"
    elif total >= 60:
        level = "Middle+"
    elif total >= 40:
        level = "Middle"
    else:
        level = "Junior / Junior+"
    
    insights_text = "\n".join(f"‚Ä¢ {i}" for i in insights[:5]) if insights else "‚Ä¢ –î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
    gaps_text = "\n".join(f"‚Ä¢ {g}" for g in gaps[:3]) if gaps else "‚Ä¢ –ù–µ –≤—ã—è–≤–ª–µ–Ω–æ"
    
    return f"""<b>1. –û–ë–©–ï–ï –í–ü–ï–ß–ê–¢–õ–ï–ù–ò–ï</b>
–ö–∞–Ω–¥–∏–¥–∞—Ç —É—Ä–æ–≤–Ω—è {level}. 
–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞–±—Ä–∞–Ω–æ {total}/100 –±–∞–ª–ª–æ–≤.

<b>2. –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´</b>
{insights_text}

<b>3. –ó–û–ù–´ –†–ê–ó–í–ò–¢–ò–Ø</b>
{gaps_text}

<b>4. HARD SKILLS</b>
–û—Ü–µ–Ω–∫–∞: {scores['hard_skills']}/30.
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —É—Ä–æ–≤–Ω—é {level}.

<b>5. SOFT SKILLS</b>
–û—Ü–µ–Ω–∫–∞: {scores['soft_skills']}/25.
–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –∏ –ª–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è.

<b>6. –ú–´–®–õ–ï–ù–ò–ï</b>
–û—Ü–µ–Ω–∫–∞: {scores['thinking']}/25.
–°–∏—Å—Ç–µ–º–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ –ø—Ä–æ—è–≤–ª–µ–Ω–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ—Ç–≤–µ—Ç–æ–≤.

<b>7. MINDSET</b>
–û—Ü–µ–Ω–∫–∞: {scores['mindset']}/20.
–ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.

<b>8. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –†–ê–ó–í–ò–¢–ò–Æ</b>
1. –£–≥–ª—É–±–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è –≤ —Å–ª–∞–±—ã—Ö –∑–æ–Ω–∞—Ö.
2. –†–∞–∑–≤–∏–≤–∞—Ç—å –Ω–∞–≤—ã–∫–∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ —Ä–µ—à–µ–Ω–∏–π.
3. –§–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –±–∏–∑–Ω–µ—Å-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö.

<b>9. –ò–¢–û–ì–û–í–´–ô –í–ï–†–î–ò–ö–¢</b>
–£—Ä–æ–≤–µ–Ω—å: {level}.
–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è (PDP).

<i>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç (AI –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω).</i>"""


def sanitize_html(text: str) -> str:
    """
    –û—á–∏—Å—Ç–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å HTML –¥–ª—è Telegram.
    
    Telegram –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ: <b>, <i>, <u>, <s>, <code>, <pre>, <a>
    """
    import re
    
    # –£–±–∏—Ä–∞–µ–º markdown –µ—Å–ª–∏ AI —Å–ª—É—á–∞–π–Ω–æ –≤—Å—Ç–∞–≤–∏–ª
    text = re.sub(r'\*\*(.+?)\*\*', r'<b>\1</b>', text)  # **bold** -> <b>bold</b>
    text = re.sub(r'\*(.+?)\*', r'<i>\1</i>', text)  # *italic* -> <i>italic</i>
    
    # –£–±–∏—Ä–∞–µ–º –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ/—Å–ª–æ–º–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏
    allowed_tags = ['b', 'i', 'u', 's', 'code', 'pre', 'a']
    
    # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ç–µ–≥–∏
    tag_pattern = r'<(/?)(\w+)([^>]*)>'
    
    def fix_tag(match):
        closing = match.group(1)
        tag_name = match.group(2).lower()
        attrs = match.group(3)
        
        if tag_name in allowed_tags:
            return f'<{closing}{tag_name}{attrs}>'
        else:
            return ''  # –£–±–∏—Ä–∞–µ–º –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–µ–≥–∏
    
    text = re.sub(tag_pattern, fix_tag, text)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å —Ç–µ–≥–æ–≤ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ
    for tag in allowed_tags:
        open_count = len(re.findall(f'<{tag}[^>]*>', text))
        close_count = len(re.findall(f'</{tag}>', text))
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏
        while close_count < open_count:
            text += f'</{tag}>'
            close_count += 1
        
        # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏
        while close_count > open_count:
            text = re.sub(f'</{tag}>', '', text, count=1)
            close_count -= 1
    
    # –£–±–∏—Ä–∞–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    text = text.replace('&', '&amp;').replace('</', '</').replace('<', '<')
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–≥–∏ –ø–æ—Å–ª–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    for tag in allowed_tags:
        text = text.replace(f'&lt;{tag}', f'<{tag}')
        text = text.replace(f'&lt;/{tag}', f'</{tag}')
    
    return text


def split_message(text: str, max_length: int = 4000) -> list[str]:
    """
    –†–∞–∑–±–∏—Ç—å –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏ –¥–ª—è Telegram.
    
    Telegram limit: 4096 —Å–∏–º–≤–æ–ª–æ–≤.
    –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    
    Args:
        text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
        max_length: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —á–∞—Å—Ç–∏
        
    Returns:
        –°–ø–∏—Å–æ–∫ —á–∞—Å—Ç–µ–π —Å–æ–æ–±—â–µ–Ω–∏—è
    """
    if len(text) <= max_length:
        return [text]
    
    parts = []
    current_part = ""
    
    # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞–º
    paragraphs = text.split("\n\n")
    
    for paragraph in paragraphs:
        # –ï—Å–ª–∏ –ø–∞—Ä–∞–≥—Ä–∞—Ñ —Å–∞–º –ø–æ —Å–µ–±–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
        if len(paragraph) > max_length:
            # –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —á–∞—Å—Ç—å
            if current_part:
                parts.append(current_part.strip())
                current_part = ""
            
            # –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
            sentences = paragraph.replace(". ", ".\n").split("\n")
            for sentence in sentences:
                if len(current_part) + len(sentence) + 2 <= max_length:
                    current_part += sentence + " "
                else:
                    if current_part:
                        parts.append(current_part.strip())
                    current_part = sentence + " "
        else:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—Å—Ç–∏—Ç—Å—è –ª–∏ –ø–∞—Ä–∞–≥—Ä–∞—Ñ
            if len(current_part) + len(paragraph) + 2 <= max_length:
                current_part += paragraph + "\n\n"
            else:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —á–∞—Å—Ç—å –∏ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é
                if current_part:
                    parts.append(current_part.strip())
                current_part = paragraph + "\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫
    if current_part:
        parts.append(current_part.strip())
    
    return parts


def split_report_into_blocks(report: str) -> list[dict]:
    """
    –†–∞–∑–±–∏—Ç—å –æ—Ç—á—ë—Ç –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.
    
    Returns:
        –°–ø–∏—Å–æ–∫ –±–ª–æ–∫–æ–≤: [{"title": "...", "content": "...", "emoji": "..."}]
    """
    import re
    
    blocks = []
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Å–µ–∫—Ü–∏–π (—á–∏—Å–ª–∞ —Å —Ç–æ—á–∫–æ–π –∏–ª–∏ –∂–∏—Ä–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫)
    section_patterns = [
        (r'1\.\s*\*?\*?–û–ë–©–ï–ï –í–ü–ï–ß–ê–¢–õ–ï–ù–ò–ï\*?\*?', 'üìå', '–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ'),
        (r'2\.\s*\*?\*?–°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´\*?\*?', 'üí™', '–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã'),
        (r'3\.\s*\*?\*?–ó–û–ù–´ –†–ê–ó–í–ò–¢–ò–Ø\*?\*?', 'üìà', '–ó–æ–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è'),
        (r'4\.\s*\*?\*?HARD SKILLS\*?\*?', 'üõ†Ô∏è', 'Hard Skills'),
        (r'5\.\s*\*?\*?SOFT SKILLS\*?\*?', 'ü§ù', 'Soft Skills'),
        (r'6\.\s*\*?\*?–ú–´–®–õ–ï–ù–ò–ï\*?\*?', 'üß†', '–ú—ã—à–ª–µ–Ω–∏–µ'),
        (r'7\.\s*\*?\*?MINDSET\*?\*?', 'üéØ', 'Mindset'),
        (r'8\.\s*\*?\*?–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò\*?\*?', 'üìù', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏'),
        (r'9\.\s*\*?\*?–ò–¢–û–ì–û–í–´–ô –í–ï–†–î–ò–ö–¢\*?\*?', 'üèÜ', '–ò—Ç–æ–≥–æ–≤—ã–π –≤–µ—Ä–¥–∏–∫—Ç'),
    ]
    
    # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    text = report
    found_sections = []
    
    for pattern, emoji, title in section_patterns:
        match = re.search(pattern, text, re.IGNORECASE)
        if match:
            found_sections.append((match.start(), emoji, title, pattern))
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–∑–∏—Ü–∏–∏
    found_sections.sort(key=lambda x: x[0])
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –æ–¥–∏–Ω –±–ª–æ–∫
    if len(found_sections) < 3:
        return [{"emoji": "üìä", "title": "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏", "content": report}]
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –∫–∞–∂–¥–æ–π —Å–µ–∫—Ü–∏–∏
    for i, (pos, emoji, title, pattern) in enumerate(found_sections):
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏ (–Ω–∞—á–∞–ª–æ —Å–ª–µ–¥—É—é—â–µ–π –∏–ª–∏ –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞)
        if i + 1 < len(found_sections):
            end_pos = found_sections[i + 1][0]
        else:
            end_pos = len(text)
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        content = text[pos:end_pos].strip()
        
        # –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–æ–Ω —É–∂–µ –≤ title)
        content = re.sub(pattern, '', content, flags=re.IGNORECASE).strip()
        content = re.sub(r'^[\s\*\:]+', '', content).strip()  # –£–±–∏—Ä–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        
        if content:
            blocks.append({
                "emoji": emoji,
                "title": title,
                "content": content,
            })
    
    return blocks

